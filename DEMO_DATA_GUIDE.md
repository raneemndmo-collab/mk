# دليل إضافة البيانات التجريبية وإدارة العقارات

## المقدمة

هذا الدليل يشرح كيفية إضافة عقارات ومديري عقارات تجريبيين عبر لوحة التحكم الإدارية، وكيفية إدارة الخريطة. كل خطوة يمكن تنفيذها يدوياً من المتصفح.

---

## 1. تسجيل الدخول كمسؤول

1. افتح المتصفح واذهب إلى: `https://mk-production-7730.up.railway.app/login`
2. أدخل بيانات الدخول:
   - **اسم المستخدم**: `admin`
   - **كلمة المرور**: `15001500`
3. اضغط **دخول**
4. اذهب إلى `/admin` لفتح لوحة التحكم

---

## 2. إضافة مدير عقارات جديد

### من لوحة التحكم:
1. اذهب إلى **إدارة المديرين** من القائمة الجانبية
2. اضغط **إضافة مدير جديد**
3. املأ البيانات:

| الحقل | مثال | ملاحظة |
|-------|------|--------|
| الاسم (عربي) | محمد العتيبي | مطلوب |
| الاسم (إنجليزي) | Mohammed Al-Otaibi | مطلوب |
| البريد الإلكتروني | mohammed@monthlykey.com | مطلوب |
| رقم الهاتف | +966501234567 | مطلوب |
| الوصف (عربي) | مدير عقارات محترف... | اختياري |
| الوصف (إنجليزي) | Professional property manager... | اختياري |
| الصورة | رفع صورة شخصية | اختياري |

4. اضغط **حفظ**

### المديرون التجريبيون المضافون:

| الاسم | البريد | الهاتف |
|-------|--------|--------|
| محمد العتيبي | mohammed@monthlykey.com | +966501234567 |
| سارة القحطاني | sara@monthlykey.com | +966509876543 |
| خالد الشمري | khalid@monthlykey.com | +966505551234 |

---

## 3. إضافة عقار جديد

### من لوحة التحكم:
1. اذهب إلى **إدارة العقارات** من القائمة الجانبية
2. اضغط **إضافة عقار جديد**
3. املأ البيانات الأساسية:

| الحقل | مثال | ملاحظة |
|-------|------|--------|
| العنوان (عربي) | شقة فاخرة في حي النرجس | مطلوب |
| العنوان (إنجليزي) | Luxury Apartment in Al-Narjis | مطلوب |
| نوع العقار | apartment / villa / studio / duplex / furnished_room / compound | مطلوب |
| الإيجار الشهري | 8500 | بالريال السعودي |
| عدد الغرف | 3 | |
| عدد الحمامات | 2 | |
| المساحة | 150 | بالمتر المربع |
| المدينة | Riyadh | باللغة الإنجليزية |
| المدينة (عربي) | الرياض | |
| الحي | Al-Narjis | باللغة الإنجليزية |
| الحي (عربي) | النرجس | |

4. **إحداثيات الموقع** (مهمة لظهور العقار على الخريطة):

| المدينة | خط العرض (Latitude) | خط الطول (Longitude) |
|---------|---------------------|----------------------|
| الرياض - النرجس | 24.8200 | 46.6250 |
| الرياض - الملقا | 24.7900 | 46.6100 |
| جدة - الحمراء | 21.5400 | 39.1700 |
| جدة - الروضة | 21.5200 | 39.1900 |
| المدينة المنورة | 24.4700 | 39.6100 |
| الدمام | 26.4300 | 50.1000 |
| مكة المكرمة | 21.4200 | 39.8300 |

5. **رفع الصور**: اضغط على منطقة رفع الصور وأضف صور العقار (يُنصح بـ 3-5 صور)
6. **الوصف**: أضف وصف تفصيلي بالعربية والإنجليزية
7. **المرافق**: اختر المرافق المتاحة (واي فاي، موقف سيارات، مسبح، إلخ)
8. اضغط **حفظ**

### تفعيل العقار:
بعد الحفظ، العقار يكون بحالة `pending`. لتفعيله:
1. اذهب إلى قائمة العقارات في لوحة التحكم
2. اضغط على العقار
3. غيّر الحالة إلى **active** (نشط)
4. اضغط **حفظ**

---

## 4. ربط مدير بعقار

1. اذهب إلى **إدارة العقارات**
2. افتح العقار المطلوب
3. في قسم **المدير المسؤول**، اختر المدير من القائمة المنسدلة
4. اضغط **حفظ**

---

## 5. العقارات التجريبية المضافة

| العقار | النوع | المدينة | الإيجار | الغرف | المساحة |
|--------|-------|---------|---------|-------|---------|
| شقة فاخرة في حي النرجس | شقة | الرياض | 8,500 ر.س | 3 | 150 م² |
| فيلا عصرية في حي الحمراء | فيلا | جدة | 15,000 ر.س | 5 | 350 م² |
| استوديو مودرن في الملقا | استوديو | الرياض | 4,200 ر.س | 1 | 55 م² |
| كمباوند عائلي في المدينة | كمباوند | المدينة المنورة | 12,000 ر.س | 4 | 280 م² |
| غرفة مفروشة في الروضة | غرفة مفروشة | جدة | 2,800 ر.س | 1 | 35 م² |

---

## 6. الخريطة (Leaflet + OpenStreetMap)

### ما تم تغييره:
تم استبدال Google Maps (الذي كان يستخدم Manus Forge proxy) بـ **Leaflet + OpenStreetMap**:
- **مجاني بالكامل** — لا يحتاج مفتاح API
- **يعمل على أي استضافة** — Railway, Vercel, أي سيرفر
- **نفس الميزات**: علامات مواقع، نوافذ معلومات، تجميع العلامات، فلاتر

### كيف تظهر العقارات على الخريطة:
- كل عقار له **إحداثيات** (latitude, longitude) يظهر كعلامة على الخريطة
- لون العلامة يعتمد على **نوع العقار**:

| نوع العقار | اللون |
|------------|-------|
| شقة | أخضر فيروزي (#3ECFC0) |
| فيلا | ذهبي (#E8B931) |
| استوديو | بنفسجي (#8B5CF6) |
| دوبلكس | برتقالي (#F97316) |
| غرفة مفروشة | وردي (#EC4899) |
| كمباوند | أخضر (#14B8A6) |
| شقة فندقية | نيلي (#6366F1) |

### الوصول للخريطة:
- الصفحة الرئيسية → **استكشف الخريطة** أو `/map`
- صفحة تفاصيل العقار → قسم **الموقع**

---

## 7. إضافة صور عبر API (للمطورين)

إذا أردت إضافة صور عبر API مباشرة:

```bash
# 1. تسجيل الدخول
curl -s -c cookies.txt -X POST "https://mk-production-7730.up.railway.app/api/trpc/auth.login" \
  -H "Content-Type: application/json" \
  -d '{"json":{"userId":"admin","password":"15001500"}}'

# 2. تحويل الصورة إلى Base64
BASE64=$(base64 -w0 photo.jpg)

# 3. رفع صورة لعقار (استبدل PROPERTY_ID)
curl -s -b cookies.txt -X POST "https://mk-production-7730.up.railway.app/api/trpc/property.uploadPhoto" \
  -H "Content-Type: application/json" \
  -d "{\"json\":{\"propertyId\":PROPERTY_ID,\"photo\":\"data:image/jpeg;base64,$BASE64\"}}"

# 4. إنشاء عقار جديد
curl -s -b cookies.txt -X POST "https://mk-production-7730.up.railway.app/api/trpc/property.create" \
  -H "Content-Type: application/json" \
  -d '{"json":{
    "titleAr":"شقة جديدة",
    "titleEn":"New Apartment",
    "descriptionAr":"وصف الشقة",
    "descriptionEn":"Apartment description",
    "propertyType":"apartment",
    "monthlyRent":"5000",
    "bedrooms":2,
    "bathrooms":1,
    "sizeSqm":100,
    "city":"Riyadh",
    "cityAr":"الرياض",
    "district":"Al-Narjis",
    "districtAr":"النرجس",
    "latitude":"24.8200",
    "longitude":"46.6250",
    "amenities":["wifi","parking","ac"]
  }}'
```

---

## 8. حل المشاكل الشائعة

### العقار لا يظهر على الخريطة
- تأكد من أن الحالة **active** (وليس pending)
- تأكد من وجود **إحداثيات** (latitude و longitude)
- تأكد من أن الإحداثيات صحيحة (خط العرض بين 15-32 للسعودية)

### الصورة لا تُرفع
- الحد الأقصى لحجم الصورة: **10 ميجابايت** (Base64)
- الصيغ المدعومة: JPEG, PNG, WebP
- تأكد من أن الصورة ليست تالفة

### الخريطة لا تظهر
- تأكد من اتصال الإنترنت (الخريطة تحتاج تحميل tiles من OpenStreetMap)
- جرب تحديث الصفحة (F5)
- تأكد من أن المتصفح لا يحجب الطلبات الخارجية

---

## 9. الملفات المعدلة

| الملف | التغيير |
|-------|---------|
| `client/src/components/Map.tsx` | استبدال Google Maps بـ Leaflet + OpenStreetMap |
| `client/src/pages/MapView.tsx` | تحديث صفحة الخريطة لاستخدام Leaflet مع clustering |
| `client/src/pages/PropertyDetail.tsx` | تحديث خريطة تفاصيل العقار لاستخدام Leaflet |
| `package.json` | إضافة leaflet, react-leaflet, leaflet.markercluster |

---

*آخر تحديث: فبراير 2026*

---

## 10. اختبار التصفح بدون تسجيل دخول + حسابات المديرين

### بيانات البذر (Seed Data)

تم إضافة **30 عقار** تجريبي مع صور متعددة لكل عقار، موزعة على 5 مدن:

| المدينة | عدد العقارات |
|---------|-------------|
| الرياض | 8 |
| جدة | 8 |
| مكة المكرمة | 6 |
| المدينة المنورة | 4 |
| الخبر | 4 |

### أنواع العقارات

| النوع | عربي | إنجليزي |
|-------|------|---------|
| studio | استوديو | Studio |
| apartment | شقة | Apartment |
| villa | فيلا | Villa |
| hotel_suite | جناح فندقي | Hotel Suite |

### المديرون (3 مديرين، 10 عقارات لكل مدير)

| المدير | الأحرف | عدد العقارات |
|--------|--------|-------------|
| سارة العتيبي / Sara Al-Otaibi | سع | 10 |
| محمد الراشدي / Mohammed Al-Rashdi | مر | 10 |
| فهد المالكي / Fahad Al-Malki | فم | 10 |

### صور العقارات

- كل عقار يحتوي على **5-10 صور** من Unsplash
- الصور مصنفة حسب نوع العقار (فيلا، شقة، استوديو، جناح فندقي)
- البطاقة تعرض: صورة رئيسية + شارة عدد الصور + كاروسيل عند التمرير (سطح المكتب)
- صفحة التفاصيل تعرض: شبكة صور + معرض بملء الشاشة (lightbox)

### اختبار التصفح بدون تسجيل دخول

1. **افتح الصفحة الرئيسية** بدون تسجيل دخول
   - ✅ البطاقات تعرض صور حقيقية مع شارة عدد الصور
   - ✅ لا توجد أيقونات صور مكسورة
   - ✅ البحث والفلاتر تعمل
   - ✅ زر "إنشاء حساب" و"دخول" مرئيان

2. **صفحة البحث** (`/search`)
   - ✅ الفلاتر: مدينة، نوع، نطاق السعر، عدد الغرف
   - ✅ التصفح بالصفحات (9 عقارات لكل صفحة)
   - ✅ البحث النصي (عربي + إنجليزي)

3. **صفحة تفاصيل العقار** (`/unit/:id`)
   - ✅ معرض الصور (شبكة + lightbox بملء الشاشة)
   - ✅ التنقل بالأسهم ولوحة المفاتيح
   - ✅ معلومات المدير والمرافق

### مكون SafeImage

مكون صورة متقدم يضمن عدم ظهور أيقونات صور مكسورة:
- **أثناء التحميل**: هيكل متحرك (shimmer skeleton)
- **عند الخطأ**: خلفية أنيقة + أيقونة "صورة غير متوفرة"
- **شارة عدد الصور**: أعلى يسار البطاقة
- **كاروسيل عند التمرير**: تقسيم الصورة لمناطق حسب عدد الصور

### صلاحيات الأدوار

| الدور | تصفح العقارات | إدارة عقاراته | إدارة جميع العقارات |
|-------|:----------:|:----------:|:----------------:|
| GUEST | ✅ | ❌ | ❌ |
| TENANT | ✅ | ❌ | ❌ |
| OWNER | ✅ | ✅ | ❌ |
| OPS_MANAGER | ✅ | ✅ | ❌ |
| ADMIN | ✅ | ✅ | ✅ |

### تشغيل الاختبارات

```bash
# تشغيل اختبارات الصور والبيانات التجريبية
npx vitest run tests/property-photos-seed.test.ts

# تشغيل جميع الاختبارات
npx vitest run tests/
```

### الملفات المضافة/المعدلة

| الملف | التغيير |
|-------|---------|
| `services/hub-api/src/db/schema.ts` | إضافة جدول `property_photos` + حقل `managerId` |
| `services/hub-api/src/routes/units.ts` | تحديث endpoints مع join للصور + قراءة عامة |
| `apps/monthlykey-web/src/data/seed-listings.ts` | 30 عقار تجريبي مع صور |
| `apps/monthlykey-web/src/components/SafeImage.tsx` | مكون صورة آمن مع skeleton + fallback |
| `apps/monthlykey-web/src/components/PhotoGallery.tsx` | معرض صور + lightbox بملء الشاشة |
| `apps/monthlykey-web/src/components/MobileHeader.tsx` | هيدر واعي بحالة المصادقة |
| `apps/monthlykey-web/src/pages/Home.tsx` | استخدام seed data + SafeImage |
| `apps/monthlykey-web/src/pages/Search.tsx` | فلاتر + تصفح بالصفحات + SafeImage |
| `apps/monthlykey-web/src/pages/UnitDetail.tsx` | معرض صور + تفاصيل كاملة |
| `scripts/seed-data.mjs` | سكربت بذر قاعدة البيانات |
| `tests/property-photos-seed.test.ts` | 23 اختبار |

---

*آخر تحديث: فبراير 2026*
