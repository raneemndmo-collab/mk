# Monthly Key - خطة تقوية الجاهزية للإنتاج

**تاريخ:** 24 فبراير 2026
**المؤلف:** Manus AI (Principal Web Architect / SRE)
**الحالة:** مسودة

## مقدمة

هذه الوثيقة تقدم خطة شاملة لتقوية موقع "المفتاح الشهري" (Monthly Key) ليكون جاهزًا للإنتاج وقادرًا على التعامل مع عدد كبير من الزوار. الهدف هو تحسين الأداء، الموثوقية، الأمان، وأساسيات محركات البحث (SEO) دون تغيير التصميم المرئي أو تجربة المستخدم الحالية. الخطة مبنية على تحليل شامل للكود المصدري والبنية التحتية الحالية للموقع.

---

## 1) الافتراضات الأساسية وما أحتاجه منك

هذا القسم يوضح الافتراضات التي بنيت عليها هذه الخطة والبيانات القليلة المطلوبة منك لإكمال عملية التقوية.

### الافتراضات

بناءً على تحليل الكود المصدري والمنصة الحالية، تم وضع الافتراضات التالية:

| الفئة | الافتراض |
| :--- | :--- |
| **المكدس التقني** | Node.js, Express, React (Vite), TypeScript, MySQL (Drizzle ORM), pnpm. |
| **الاستضافة** | Railway (عبر Dockerfile). |
| **نظام إدارة المحتوى** | نظام مخصص مدمج في لوحة تحكم الأدمن. |
| **المصادقة** | نظام مخصص يعتمد على JWT مع تسجيل دخول عبر البريد الإلكتر الإلكتروني/كلمة المرور. |
| **المدفوعات** | تكامل مع PayPal موجود، لكن مفاتيح الربط (الإنتاج/التجريبي) مخزنة في قاعدة البيانات. |
| **تخزين الملفات** | تخزين محلي على وحدة تخزين دائمة (`/app/uploads`) مقدمة من Railway. |
| **التحليلات** | Google Analytics (GA4) معد في `index.html` ولكنه يتطلب `VITE_GA_MEASUREMENT_ID`. وأيضًا توجد إشارة إلى أداة تحليل أخرى (Umami). |

### البيانات المطلوبة منك

لإكمال عملية التقوية بشكل فعال، يرجى تزويدي بالمعلومات التالية عبر إضافتها كـ "Secrets" في بيئة Railway:

- **معرفات التحليلات (Analytics IDs):**
  - `VITE_GA_MEASUREMENT_ID` الخاص بـ Google Analytics 4.
  - `VITE_ANALYTICS_ENDPOINT` و `VITE_ANALYTICS_WEBSITE_ID` الخاص بـ Umami.
- **اسم النطاق النهائي (Production Domain):** اسم النطاق الرسمي الذي سيستخدمه الموقع لضبط ترويسات الأمان (CSP, HSTS) بشكل صحيح.
- **بيانات البريد الإلكتروني (SMTP):** بيانات اعتماد خادم SMTP للبيئة الإنتاجية (`SMTP_HOST`, `SMTP_PORT`, `SMTP_USER`, `SMTP_PASS`) لإرسال رسائل البريد الإلكتروني للمعاملات.
- **مفاتيح إشعارات الدفع (VAPID Keys):** مفاتيح VAPID للبيئة الإنتاجية لإرسال إشعارات الويب.
- **تفاصيل العمل الرسمية:** اسم الشركة الرسمي، العنوان، ومعلومات الاتصال لتضمينها في بيانات SEO المنظمة والصفحات القانونية.

---

## 2) المتطلبات الأساسية غير القابلة للتفاوض لموقع يتحمل ضغطًا عاليًا

كل موقع إنتاجي مصمم للتعامل مع عدد كبير من الزوار يجب أن يفي بالمعايير التالية. هذه القائمة تمثل الحد الأدنى المطلوب لضمان تجربة مستخدم جيدة وموثوقية عالية.

| الفئة | المتطلب الأساسي | الحالة الحالية |
| :--- | :--- | :--- |
| **الأداء** | **ضغط الأصول (Asset Compression):** يجب ضغط جميع أصول النص (JS, CSS, HTML) باستخدام Brotli أو Gzip. | **غير مطبق.** الخادم لا يطبق ضغط Gzip أو Brotli. |
| | **تحسين الصور (Image Optimization):** يجب تقديم الصور بتنسيق WebP وبأحجام متجاوبة. | **مطبق جزئيًا.** يوجد نظام تحسين للصور عند الرفع، لكن لا يتم استخدامه لكل الصور. |
| | **شبكة توصيل المحتوى (CDN):** يجب تقديم جميع الأصول الثابتة (JS, CSS, صور) عبر CDN عالمي. | **مطبق.** Railway توفر CDN بشكل افتراضي (Fastly). |
| **الأمان** | **HTTPS إلزامي:** يجب أن يتم فرض استخدام HTTPS على جميع الطلبات. | **مطبق.** الموقع يعمل عبر HTTPS. |
| | **ترويسات الأمان (Security Headers):** يجب تطبيق ترويسات أمان حديثة مثل CSP, HSTS, X-Frame-Options. | **غير مطبق.** لا توجد ترويسات أمان مخصصة. |
| | **إدارة الأسرار (Secrets Management):** يجب ألا يتم تخزين أي مفاتيح ربط أو كلمات مرور في الكود المصدري. | **مطبق.** يتم استخدام متغيرات البيئة (Environment Variables). |
| **تحسين محركات البحث (SEO)** | **العلامات الوصفية الأساسية (Core Meta Tags):** يجب أن تحتوي كل صفحة على `title` و `meta description` فريد. | **مطبق.** يوجد مكون `SEOHead` لإدارة العلامات. |
| | **خريطة الموقع (Sitemap) و `robots.txt`:** يجب توفير `sitemap.xml` و `robots.txt` لتوجيه عناكب البحث. | **غير مطبق.** الملفات غير موجودة. |
| **إمكانية الوصول (Accessibility)** | **التنقل عبر لوحة المفاتيح (Keyboard Navigation):** يجب أن يكون الموقع قابلاً للتصفح بالكامل باستخدام لوحة المفاتيح فقط. | **مطبق جزئيًا.** العناصر الأساسية قابلة للوصول، لكن بعض المكونات قد تحتاج لمراجعة. |
| | **تباين الألوان (Color Contrast):** يجب أن يفي تباين الألوان بمعايير WCAG 2.2 AA. | **يحتاج لمراجعة.** يتطلب تدقيقًا كاملاً. |
| **الموثوقية/البنية التحتية** | **النسخ الاحتياطي (Backups):** يجب وجود خطة نسخ احتياطي تلقائي لقاعدة البيانات والملفات المرفوعة. | **غير معروف.** يعتمد على إعدادات Railway. |
| | **مراقبة وقت التشغيل (Uptime Monitoring):** يجب مراقبة الموقع على مدار الساعة وتلقي تنبيهات عند انقطاع الخدمة. | **غير مطبق.** يتطلب إعداد أداة خارجية. |
| **المراقبة والتحليل** | **تتبع الأخطاء (Error Tracking):** يجب تسجيل أخطاء الواجهة الأمامية والخلفية في منصة مركزية مثل Sentry. | **غير مطبق.** |
| | **تحليلات المستخدم (User Analytics):** يجب تتبع سلوك المستخدم بشكل مجهول لفهم كيفية استخدام الموقع. | **مطبق جزئيًا.** تم إعداد GA4/Umami ولكنهما غير مفعلان. |
| **الامتثال/الخصوصية** | **لافتة الموافقة على ملفات تعريف الارتباط (Cookie Consent):** يجب الحصول على موافقة المستخدم قبل تخزين ملفات تعريف الارتباط غير الضرورية. | **مطبق.** توجد لافتة موافقة. |

---

## 3) خطة البنية التحتية للتعامل مع عدد كبير من الزوار (مع الحفاظ على التصميم)

لضمان استقرار الموقع تحت ضغط عالٍ دون تغيير التصميم، نقترح التحسينات التالية على البنية التحتية.

### استراتيجية شبكة توصيل المحتوى (CDN) والتخزين المؤقت عند الحافة (Edge Caching)

تستخدم Railway شبكة Fastly كـ CDN، وهي بداية ممتازة. لتعظيم الفائدة، يجب تطبيق الاستراتيجية التالية:

- **الأصول الثابتة (Static Assets):**
  - **الملفات:** `*.js`, `*.css`, `*.woff2`.
  - **استراتيجية التخزين:** تخزين مؤقت طويل جدًا (`max-age=31536000, immutable`) بناءً على أسماء الملفات التي تحتوي على هاش (Vite يقوم بذلك تلقائيًا).
  - **مفتاح التخزين المؤقت:** عنوان URL الكامل للملف.
- **الصور المحسّنة (Optimized Images):**
  - **الملفات:** الصور الموجودة في `/uploads/`.
  - **استراتيجية التخزين:** تخزين مؤقت متوسط المدة (`max-age=604800` - أسبوع واحد) مع التحقق من صحة `ETag`.
  - **مفتاح التخزين المؤقت:** عنوان URL الكامل للصورة.
- **استراتيجية الإبطال (Purge Strategy):** بما أن الأصول الثابتة تحتوي على هاش، فإن الإبطال غير مطلوب. عند تحديث الموقع، سيتم إنشاء ملفات جديدة بأسماء مختلفة. بالنسبة للصور، يمكن إبطالها يدويًا عبر لوحة تحكم Fastly إذا لزم الأمر.

### استراتيجية العرض (Rendering Strategy)

الموقع الحالي هو تطبيق من جانب العميل (Client-Side Rendered - CSR). هذا مناسب، ولكن يمكن تحسينه:

- **الصفحات العامة (Public Pages):** الصفحات مثل الرئيسية، الأسئلة الشائعة، والشروط يمكن تحويلها إلى **إنشاء موقع ثابت (Static Site Generation - SSG)**. هذا يعني أن يتم إنشاء ملفات HTML مسبقًا أثناء عملية البناء، مما يوفر أسرع وقت ممكن للوصول (TTFB).
- **صفحات التفاصيل (Detail Pages):** صفحات مثل تفاصيل العقار يمكن أن تستخدم **التجديد الثابت التدريجي (Incremental Static Regeneration - ISR)**. يتم إنشاء نسخة ثابتة عند الطلب الأول، ثم يتم تحديثها في الخلفية بشكل دوري.
- **الصفحات المحمية (Protected Pages):** لوحات التحكم يجب أن تظل CSR كما هي.

### خطة تحسين الصور والوسائط

- **التنسيقات:** يجب التأكد من أن جميع الصور التي يتم رفعها يتم تحويلها إلى **WebP** و **AVIF** لتقليل الحجم مع الحفاظ على الجودة.
- **الأحجام المتجاوبة:** يجب استخدام السمة `srcset` في وسوم `<img>` لتقديم صور بأحجام مختلفة بناءً على حجم شاشة المستخدم.
- **التحميل الكسول (Lazy Loading):** يجب تطبيق التحميل الكسول على جميع الصور التي تقع خارج إطار العرض الأولي باستخدام `loading="lazy"`.

### خطة حماية واجهة برمجة التطبيقات (API)

- **تحديد المعدل (Rate Limiting):** يوجد محدد معدل في الذاكرة (`server/rate-limiter.ts`)، وهو جيد للبدء. للبيئة الإنتاجية، يجب استبداله بـ **Redis** ليعمل عبر عدة نسخ من التطبيق. يجب تطبيق حدود صارمة على نقاط النهاية الحساسة مثل تسجيل الدخول وإنشاء الحساب.
- **جدار حماية تطبيقات الويب (WAF):** يجب تفعيل WAF على مستوى CDN (مثل Fastly WAF أو Cloudflare) لحماية الموقع من هجمات شائعة مثل حقن SQL و XSS.
- **حماية الروبوتات (Bot Protection):** يجب استخدام خدمة مثل Cloudflare Bot Management أو hCaptcha على نماذج التسجيل وتسجيل الدخول لمنع الهجمات الآلية.

### خطة توسيع قاعدة البيانات

- **الفهرسة (Indexing):** **هذا هو الإجراء الأكثر أهمية.** يجب إضافة فهارس إلى الأعمدة التي يتم البحث عنها بشكل متكرر في قاعدة البيانات (مثل `properties.city`, `users.email`, `bookings.propertyId`). بدون فهارس، ستكون الاستعلامات بطيئة جدًا تحت الحمل.
- **تجميع الاتصالات (Connection Pooling):** يستخدم `mysql2` تجميع الاتصالات افتراضيًا، وهو أمر جيد. يجب التأكد من أن حجم التجمع (`connectionLimit`) مناسب لحمل العمل المتوقع.
- **نسخ القراءة (Read Replicas):** إذا زاد حمل القراءة بشكل كبير، يمكن إعداد نسخ للقراءة من قاعدة البيانات وتوجيه استعلامات القراءة إليها.

### خطة المهام الخلفية (Background Jobs)

المهام التي تستغرق وقتًا طويلاً مثل إرسال رسائل البريد الإلكتروني أو معالجة الويب هوك يجب نقلها إلى **قائمة انتظار مهام (Job Queue)** مثل BullMQ مع Redis. هذا يمنع حظر الخادم ويحسن الاستجابة.

### استراتيجية البحث

يعتمد البحث الحالي على استعلامات `LIKE` في قاعدة البيانات، وهو غير فعال للبيانات الكبيرة. يجب استبداله بـ **محرك بحث مخصص** مثل Meilisearch أو Algolia للحصول على بحث فوري وقابل للتطوير.

### استراتيجية تخزين الملفات

التخزين المحلي على Railway جيد للبدء، ولكنه غير قابل للتطوير أفقيًا. على المدى الطويل، يجب الانتقال إلى **تخزين كائنات سحابي (Cloud Object Storage)** مثل AWS S3 أو Cloudflare R2. هذا يوفر قابلية تطوير غير محدودة وموثوقية أعلى.

---

## 4) ميزانيات وأهداف الأداء (أرقام محددة)

لضمان تجربة مستخدم سريعة، يجب تحديد أهداف أداء قابلة للقياس. الفشل في تلبية هذه الميزانيات يشير إلى وجود مشكلة تحتاج إلى حل فوري.

| المقياس | الأداة | الهدف | اختبار القبول |
| :--- | :--- | :--- | :--- |
| **مؤشرات الويب الأساسية (Core Web Vitals)** | | | |
| Largest Contentful Paint (LCP) | Lighthouse, WebPageTest, RUM | **< 2.5 ثانية** | يجب أن يحقق 75% من المستخدمين هذا الهدف. |
| Interaction to Next Paint (INP) | Lighthouse, RUM | **< 200 مللي ثانية** | يجب أن يحقق 75% من المستخدمين هذا الهدف. |
| Cumulative Layout Shift (CLS) | Lighthouse, WebPageTest, RUM | **< 0.1** | يجب أن يحقق 75% من المستخدمين هذا الهدف. |
| **مقاييس أخرى** | | | |
| Time to First Byte (TTFB) | WebPageTest, FastOrSlow | **< 800 مللي ثانية** | يجب أن يكون متوسط TTFB من مواقع متعددة أقل من 800 مللي ثانية. |
| **ميزانيات الموارد** | | | |
| حجم حزمة JavaScript | Lighthouse, Webpack Bundle Analyzer | **< 250 كيلوبايت (مضغوط)** | يجب ألا يتجاوز حجم حزمة JS الرئيسية 250 كيلوبايت. (الحالي: ~1.6 ميجابايت غير مضغوط) |
| حجم الصور (الصفحة الرئيسية) | Lighthouse, WebPageTest | **< 1 ميجابايت (إجمالي)** | يجب أن يكون إجمالي حجم الصور في الصفحة الرئيسية أقل من 1 ميجابايت. |
| عدد الطلبات (الصفحة الرئيسية) | WebPageTest | **< 50 طلبًا** | يجب ألا يتجاوز إجمالي عدد الطلبات عند التحميل الأولي 50. |
| نصوص الطرف الثالث (3rd Party Scripts) | Lighthouse | **< 50 كيلوبايت** | يجب ألا يتجاوز حجم نصوص الطرف الثالث (مثل التحليلات) 50 كيلوبايت. |

### أدوات التحقق

- **Lighthouse:** أداة مدمجة في متصفح Chrome لفحص الأداء وإمكانية الوصول ومحركات البحث.
- **WebPageTest:** أداة متقدمة لاختبار أداء الويب من مواقع مختلفة حول العالم.
- **Real User Monitoring (RUM):** أدوات مثل Datadog أو Sentry لمراقبة أداء الموقع للمستخدمين الفعليين.

---

## 5) قائمة تدقيق تقوية الأمان (لحركة مرور عالية وتهديدات حقيقية)

تعتبر حماية الموقع وبيانات المستخدمين أولوية قصوى. هذه القائمة تغطي الإجراءات الأمنية الأساسية التي يجب تطبيقها.

| الإجراء الأمني | الأهمية | كيفية التحقق |
| :--- | :--- | :--- |
| **HTTPS و HSTS** | **حرج** | تأكد من أن `Strict-Transport-Security` header موجود مع `max-age` طويل (مثل `max-age=31536000; includeSubDomains; preload`). |
| **سياسة أمان المحتوى (CSP)** | **عالي** | أضف `Content-Security-Policy` header. ابدأ بسياسة تقرير فقط (`Content-Security-Policy-Report-Only`) لتجنب كسر الموقع، ثم انتقل إلى سياسة فرض بعد تحليل التقارير. |
| **ترويسات الأمان الأخرى** | **عالي** | أضف الترويسات التالية: `X-Content-Type-Options: nosniff`, `X-Frame-Options: DENY` (أو `SAMEORIGIN`), `Referrer-Policy: strict-origin-when-cross-origin`, `Permissions-Policy`. |
| **التحقق من صحة المدخلات وتعقيمها** | **حرج** | **مطبق جزئيًا.** يوجد تعقيم أساسي (`sanitizeText`). يجب توسيعه ليشمل التحقق من صحة جميع مدخلات المستخدم من جانب الخادم باستخدام مكتبة مثل Zod. |
| **أمان المصادقة والجلسات** | **حرج** | **مطبق جزئيًا.** يجب أن تستخدم ملفات تعريف الارتباط للجلسة العلامات التالية: `HttpOnly`, `Secure`, `SameSite=Strict` (أو `Lax`). حاليًا تستخدم `SameSite=None` وهو أقل أمانًا. |
| **الحماية من CSRF** | **عالي** | **غير مطبق.** يجب تطبيق حماية ضد هجمات CSRF، إما باستخدام نمط Double Submit Cookie أو ترويسة `Anti-CSRF-Token`. |
| **تحديد المعدل والدفاع ضد الروبوتات** | **عالي** | طبق تحديد المعدل على نماذج تسجيل الدخول والتسجيل. استخدم hCaptcha أو reCAPTCHA لمنع هجمات القوة الغاشمة (Brute Force). |
| **إدارة الأسرار** | **حرج** | **مطبق.** يتم استخدام متغيرات البيئة. تأكد من عدم تسريب أي أسرار إلى الواجهة الأمامية. |
| **إدارة نقاط ضعف التبعيات** | **متوسط** | قم بتشغيل `pnpm audit` بانتظام وقم بتحديث التبعيات التي تحتوي على ثغرات أمنية معروفة. |
| **منع إساءة الاستخدام** | **متوسط** | طبق آليات لمنع تعداد الحسابات (Account Enumeration) والبريد العشوائي في النماذج العامة. |

---

## 6) قائمة تدقيق أساسيات تحسين محركات البحث (SEO) (بدون تغيير التصميم)

لضمان ظهور الموقع بشكل جيد في نتائج البحث، يجب تطبيق أساسيات SEO التالية.

- **عناوين وأوصاف فريدة:**
  - **الحالة:** مطبق عبر مكون `SEOHead`.
  - **الإجراء:** تأكد من أن كل نوع صفحة (عقار، مدينة، مقال) يستخدم عناوين وأوصافًا فريدة وديناميكية.
- **العناوين الأساسية (Canonicals):**
  - **الحالة:** مطبق عبر مكون `SEOHead`.
  - **الإجراء:** تحقق من أن `link rel="canonical"` يشير دائمًا إلى عنوان URL المفضل للصفحة لتجنب المحتوى المكرر.
- **`robots.txt` و `sitemap.xml`:**
  - **الحالة:** غير مطبق.
  - **الإجراء:** قم بإنشاء ملف `public/robots.txt` للسماح لجميع عناكب البحث ومنع الوصول إلى المسارات الإدارية. قم بإنشاء `sitemap.xml` ديناميكيًا (أو أثناء البناء) يحتوي على جميع الصفحات العامة.
- **بطاقات OpenGraph و Twitter:**
  - **الحالة:** مطبق عبر مكون `SEOHead`.
  - **الإجراء:** أضف `og:image` إلى العلامات لتحديد صورة مميزة عند مشاركة الرابط على وسائل التواصل الاجتماعي.
- **البيانات المنظمة (Structured Data):**
  - **الحالة:** مطبق جزئيًا (Organization, WebSite, RealEstateAgent).
  - **الإجراء:** قم بتوسيع البيانات المنظمة لتشمل `RealEstateListing` لكل عقار، و `FAQPage` لصفحة الأسئلة الشائعة، و `BreadcrumbList` لتحسين التنقل.
- **صحة عناوين URL:**
  - **الحالة:** جيدة.
  - **الإجراء:** استخدم عناوين URL واضحة وقصيرة (مثل `/property/123/modern-riyadh-apartment`).
- **استراتيجية 404 وإعادة التوجيه:**
  - **الحالة:** مطبق (يوجد صفحة 404 مخصصة).
  - **الإجراء:** تأكد من أن الصفحة 404 تعيد رمز الحالة 404 الصحيح. قم بإعداد إعادة توجيه 301 للعناوين القديمة إذا تغيرت.

### قالب مقترح لـ `robots.txt`

```
User-agent: *
Allow: /
Disallow: /admin
Disallow: /login
Disallow: /register
Disallow: /api

Sitemap: https://www.monthlykey.com/sitemap.xml
```

---

## 7) إمكانية الوصول والامتثال لتجربة المستخدم (بدون إعادة تصميم مرئي)

يجب أن يكون الموقع قابلاً للاستخدام من قبل الجميع، بما في ذلك الأشخاص ذوي الإعاقة. هذا ليس فقط مطلبًا قانونيًا في العديد من المناطق، ولكنه أيضًا يحسن تجربة المستخدم للجميع.

- **قائمة تدقيق WCAG 2.2 AA:**
  - **الإجراء:** قم بإجراء تدقيق كامل للموقع باستخدام أداة مثل **axe DevTools**. ركز على إصلاح المشكلات الحرجة والعالية أولاً.
- **حالات التركيز (Focus States):**
  - **الحالة:** مطبق جزئيًا (يستخدم `focus-visible`).
  - **الإجراء:** تأكد من أن كل عنصر تفاعلي (رابط، زر، حقل إدخال) له حالة تركيز مرئية وواضحة عند التنقل باستخدام لوحة المفاتيح.
- **التنقل عبر لوحة المفاتيح:**
  - **الإجراء:** اختبر الموقع بالكامل باستخدام مفتاح `Tab` فقط. تأكد من أن ترتيب التركيز منطقي وأنه لا توجد "مصائد لوحة مفاتيح" (مناطق لا يمكن الخروج منها).
- **تسميات النماذج ورسائل الخطأ:**
  - **الإجراء:** تأكد من أن كل حقل إدخال له تسمية (`<label>`) مرتبطة به برمجيًا. يجب أن تكون رسائل الخطأ واضحة ومرتبطة بالحقل ذي الصلة.
- **تدقيق تباين الألوان:**
  - **الإجراء:** استخدم أداة فحص التباين للتحقق من أن جميع النصوص تفي بنسبة تباين 4.5:1 على الأقل (لمعيار AA). إذا كان هناك فشل، قم بتعديل قيم الألوان بشكل طفيف دون تغيير التصميم العام.
- **أنماط ARIA:**
  - **الإجراء:** استخدم سمات ARIA المناسبة للمكونات المعقدة مثل النوافذ المنبثقة (Modals) والأكورديون. على سبيل المثال، استخدم `role="dialog"` و `aria-modal="true"` للنوافذ المنبثقة.
- **تقليل الحركة (Reduced Motion):**
  - **الحالة:** غير مطبق.
  - **الإجراء:** قم بلف الحركات المعقدة (مثل تأثيرات Framer Motion) في استعلام وسائط `prefers-reduced-motion` لتعطيلها للمستخدمين الذين يفضلون ذلك.

### اختبارات القبول

- **اختبار axe:** يجب ألا تظهر أي انتهاكات حرجة أو خطيرة في عمليات الفحص الآلي.
- **اختبار لوحة المفاتيح فقط:** يجب أن تكون جميع الوظائف قابلة للإكمال باستخدام لوحة المفاتيح فقط.
- **فحوصات قارئ الشاشة:** قم بإجراء فحوصات موضعية باستخدام قارئ شاشة (مثل NVDA أو VoiceOver) على الصفحات الرئيسية والمسارات الحرجة.

---

## 8) خطة التحليلات والقياس (لعدد كبير من الزوار وبيانات نظيفة)

لفهم سلوك المستخدم وتحسين الموقع، يجب تطبيق خطة قياس قوية.

- **منصة التحليلات:**
  - **الاقتراح:** استخدم **Google Analytics 4 (GA4)** كأداة أساسية و **Umami** كبديل خفيف الوزن وموجه نحو الخصوصية. الكود موجود بالفعل، يحتاج فقط إلى تفعيل عبر متغيرات البيئة.
  - **التتبع من جانب الخادم:** على المدى الطويل، فكر في الانتقال إلى التتبع من جانب الخادم لزيادة دقة البيانات وتجاوز أدوات حظر الإعلانات.
- **اتفاقية تسمية الأحداث:**
  - **الاقتراح:** اتبع نمط `object_verb` (مثل `property_viewed`, `booking_started`). هذا يجعل البيانات سهلة الفهم والتحليل.
- **المسارات والتحويلات الرئيسية:**
  - **الإجراء:** قم بتعريف وتتبع المسارات الرئيسية في الموقع، مثل:
    1.  **مسار حجز العقار:** `property_viewed` -> `booking_started` -> `payment_initiated` -> `booking_completed`.
    2.  **مسار إضافة عقار:** `list_property_clicked` -> `property_form_submitted` -> `property_published`.
- **استراتيجية UTM:**
  - **الإجراء:** استخدم معلمات UTM بشكل منهجي في جميع الحملات التسويقية لتتبع مصادر الزوار وقياس فعالية كل حملة.
- **الموافقة على ملفات تعريف الارتباط:**
  - **الحالة:** مطبق.
  - **الإجراء:** تأكد من أن نصوص التحليلات لا تعمل إلا بعد الحصول على موافقة صريحة من المستخدم عبر لافتة الموافقة.
- **تتبع الأخطاء ومراقبة الأداء:**
  - **الاقتراح:** قم بدمج **Sentry** لتتبع أخطاء JavaScript في الواجهة الأمامية وأخطاء الخادم. استخدم ميزة مراقبة الأداء (RUM) في Sentry لمراقبة مؤشرات الويب الأساسية للمستخدمين الفعليين.

### قالب قائمة الأحداث المقترحة

| اسم الحدث | الوصف | المشغل |
| :--- | :--- | :--- |
| `page_view` | مشاهدة صفحة | عند تغيير المسار |
| `login` | تسجيل دخول ناجح | بعد نجاح المصادقة |
| `register` | تسجيل حساب جديد | بعد نجاح إنشاء الحساب |
| `search` | إجراء بحث عن عقارات | عند إرسال نموذج البحث |
| `property_viewed` | مشاهدة تفاصيل عقار | عند تحميل صفحة تفاصيل العقار |
| `booking_started` | بدء عملية الحجز | عند النقر على زر "احجز الآن" |
| `booking_completed` | إكمال حجز ناجح | عند الوصول إلى صفحة نجاح الدفع |
| `lead_generated` | إرسال نموذج "تواصل معنا" | عند إرسال النموذج بنجاح |

---

## 9) المراقبة والموثوقية (تشغيل كمنتج حقيقي)

لضمان تشغيل الموقع بشكل موثوق، يجب تطبيق ممارسات هندسة موثوقية الموقع (SRE).

- **مراقبة وقت التشغيل والتنبيهات:**
  - **الاقتراح:** استخدم خدمة مثل **UptimeRobot** أو **Better Uptime** لمراقبة نقطة نهاية فحص الصحة (`/`) في الموقع كل دقيقة. قم بإعداد تنبيهات عبر البريد الإلكتروني والرسائل النصية ليتم إعلامك فورًا في حالة انقطاع الخدمة.
  - **اتفاقيات مستوى الخدمة (SLAs/SLOs):** حدد هدفًا لوقت التشغيل (SLO)، على سبيل المثال **99.9%**.
- **هيكل التسجيل (Logging):**
  - **الحالة:** التسجيل الحالي يذهب إلى `console.log`.
  - **الاقتراح:** استخدم مكتبة تسجيل منظمة (مثل Pino) لإخراج السجلات بتنسيق JSON. قم بإرسال هذه السجلات إلى مجمع سجلات مركزي (مثل Datadog Logs أو Logtail) لتحليلها والبحث فيها بسهولة. **تأكد من عدم تسجيل أي معلومات تعريف شخصية (PII)** في السجلات.
- **التتبع (Tracing):**
  - **الاقتراح:** قم بدمج تتبع الطلبات الموزعة (Distributed Tracing) باستخدام OpenTelemetry. هذا يسمح لك بتتبع طلب واحد عبر خدمات متعددة (الواجهة الأمامية، الخادم، قاعدة البيانات) وتحديد نقاط الاختناق.
- **دليل التشغيل (Runbook):**
  - **الإجراء:** قم بإنشاء وثيقة بسيطة تحدد خطوات الاستجابة للحوادث الشائعة، مثل "ماذا تفعل إذا توقف الموقع عن العمل؟" أو "ماذا تفعل إذا كانت قاعدة البيانات تحت ضغط عالٍ؟".
- **استراتيجية النشر:**
  - **الحالة:** نشر مباشر إلى الإنتاج.
  - **الاقتراح:** قم بإعداد بيئة **مرحلية (Staging)** منفصلة على Railway تكون نسخة طبق الأصل من البيئة الإنتاجية. اختبر جميع التغييرات في البيئة المرحلية قبل نشرها إلى الإنتاج. استخدم **أعلام الميزات (Feature Flags)** لنشر الميزات الجديدة تدريجيًا لمجموعة فرعية من المستخدمين.
- **خطة اختبار الحمل:**
  - **الاقتراح:** استخدم أداة مثل **k6** أو **Locust** لإجراء اختبارات الحمل على البيئة المرحلية. حدد سيناريوهات واقعية:
    1.  **تصفح الصفحة الرئيسية:** محاكاة عدد كبير من المستخدمين يتصفحون الصفحة الرئيسية.
    2.  **مسار الحجز الحرج:** محاكاة مستخدمين يقومون بالبحث عن عقار وحجزه.
    3.  **ضغط واجهة برمجة التطبيقات:** اختبار نقاط النهاية الأكثر استخدامًا بشكل مباشر.
  - **الهدف:** تحديد عدد الطلبات في الثانية (RPS) الذي يمكن للنظام التعامل معه قبل أن يبدأ الأداء في التدهور.

---

## 10) قائمة المهام للتنفيذ (Punch List)

هذه قائمة مهام ذات أولوية تم إنشاؤها بناءً على التحليل. يجب معالجة هذه العناصر لضمان أن الموقع جاهز للإنتاج.

| الأهمية | المجال | المهمة | التأثير المتوقع | كيفية التحقق |
| :--- | :--- | :--- | :--- | :--- |
| **حرج** | قاعدة البيانات | **إضافة فهارس (Indexes) إلى قاعدة البيانات:** إضافة فهارس إلى أعمدة المفاتيح الخارجية (مثل `landlordId`, `propertyId`) والأعمدة التي يتم البحث فيها بشكل متكرر (مثل `users.email`, `properties.city`). | تحسين جذري في سرعة استعلامات قاعدة البيانات وتقليل الحمل على الخادم. | انخفاض زمن استجابة واجهة برمجة التطبيقات (API) لأقل من 200 مللي ثانية تحت الحمل. |
| **حرج** | الأداء | **تفعيل ضغط Brotli/Gzip:** قم بتهيئة الخادم لضغط جميع استجابات النص (HTML, CSS, JS) باستخدام ضغط Brotli أو Gzip. | تقليل حجم الأصول المنقولة بنسبة تصل إلى 70-80%، مما يسرع بشكل كبير من وقت تحميل الصفحة. | تحقق من وجود ترويسة `content-encoding: br` أو `content-encoding: gzip` في استجابات الشبكة. |
| **حرج** | الأمان | **تطبيق ترويسات الأمان الأساسية:** قم بإضافة ترويسات `Strict-Transport-Security` (HSTS), `Content-Security-Policy` (CSP), `X-Content-Type-Options`, `X-Frame-Options`. | حماية المستخدمين من هجمات مثل سرقة الجلسات (session hijacking) وهجمات XSS. | استخدم أدوات فحص الترويسات عبر الإنترنت (مثل securityheaders.com) للتحقق من وجودها. |
| **حرج** | الأمان | **تأمين ملفات تعريف الارتباط للجلسة:** قم بتغيير `SameSite=None` إلى `SameSite=Lax` أو `Strict`. قم بإزالة `domain` إذا لم تكن هناك حاجة للمصادقة عبر نطاقات فرعية. | منع هجمات CSRF الأساسية وحماية ملفات تعريف الارتباط من التسريب. | تحقق من سمات ملف تعريف الارتباط في أدوات المطور في المتصفح. |
| **عالي** | الأداء | **تقليل حجم حزمة JavaScript:** قم بتحليل الحزمة باستخدام `rollup-plugin-visualizer` وتحديد المكتبات الكبيرة. استبدل المكتبات الثقيلة ببدائل أخف (مثل `date-fns` بدلاً من `moment.js`). | تحسين كبير في وقت التحميل التفاعلي (Time to Interactive) وتقليل استهلاك الذاكرة على أجهزة المستخدمين. | يجب أن يكون حجم الحزمة الرئيسية أقل من 250 كيلوبايت (مضغوط). |
| **عالي** | تحسين محركات البحث | **إنشاء `robots.txt` و `sitemap.xml`:** قم بإنشاء ملف `robots.txt` في المجلد العام وإنشاء خريطة موقع ديناميكية تحتوي على جميع الصفحات العامة. | تحسين فهرسة الموقع من قبل محركات البحث وضمان اكتشاف جميع الصفحات المهمة. | تحقق من أن الملفين يمكن الوصول إليهما (e.g., `/robots.txt`, `/sitemap.xml`). |
| **عالي** | الموثوقية | **دمج Sentry لتتبع الأخطاء:** قم بإضافة Sentry SDK إلى الواجهة الأمامية والخلفية لتسجيل الأخطاء تلقائيًا. | الحصول على رؤية فورية للأخطاء التي يواجهها المستخدمون، مما يسمح بإصلاحها بسرعة. | تحقق من ظهور الأخطاء في لوحة تحكم Sentry عند حدوثها. |
| **عالي** | الموثوقية | **إعداد مراقبة وقت التشغيل (Uptime Monitoring):** استخدم خدمة خارجية (مثل UptimeRobot) لمراقبة صحة الموقع كل دقيقة. | تلقي تنبيهات فورية في حالة تعطل الموقع، مما يقلل من وقت التوقف عن العمل. | استلم تنبيهًا تجريبيًا بنجاح. |
| **متوسط** | قاعدة البيانات | **استخدام Redis لمحدد المعدل والتخزين المؤقت:** استبدل التطبيقات الموجودة في الذاكرة بـ Redis لضمان الاتساق عبر عدة نسخ من التطبيق. | زيادة موثوقية تحديد المعدل والتخزين المؤقت في بيئة قابلة للتطوير أفقيًا. | امسح ذاكرة التخزين المؤقت من نسخة واحدة وتحقق من أنها فارغة في نسخة أخرى. |
| **متوسط** | إمكانية الوصول | **إجراء تدقيق WCAG 2.2 AA كامل:** استخدم أداة axe DevTools لتحديد وإصلاح مشكلات إمكانية الوصول. | ضمان أن الموقع قابل للاستخدام من قبل الأشخاص ذوي الإعاقة والامتثال للمعايير القانونية. | يجب ألا تظهر أي مشكلات "حرجة" أو "خطيرة" في تقرير axe. |

---

## 11) بوابة الإطلاق النهائية (Go-Live Gate)

قبل إطلاق الموقع رسميًا للجمهور، يجب أن تجتاز جميع العناصر التالية هذا الفحص النهائي. أي عنصر يفشل يتطلب اهتمامًا فوريًا قبل المتابعة.

| الفئة | العنصر | معيار النجاح (PASS/FAIL) |
| :--- | :--- | :--- |
| **البنية التحتية** | **تم تكوين اسم النطاق الإنتاجي** | **PASS:** تم تكوين DNS بشكل صحيح ويشير إلى Railway. |
| | **تم تكوين متغيرات البيئة الإنتاجية** | **PASS:** جميع الأسرار (قاعدة البيانات، SMTP، GA4، VAPID) موجودة في بيئة الإنتاج. |
| | **تم إعداد النسخ الاحتياطي لقاعدة البيانات** | **PASS:** تم تكوين نسخ احتياطية يومية تلقائية لقاعدة البيانات على Railway. |
| **الأداء** | **ضغط Brotli/Gzip مفعل** | **PASS:** ترويسة `content-encoding` موجودة في استجابات الأصول. |
| | **LCP أقل من 2.5 ثانية** | **PASS:** نتيجة Lighthouse تظهر LCP ضمن الهدف. |
| | **حجم حزمة JS أقل من 250 كيلوبايت** | **PASS:** تحليل الحزمة يؤكد أن الحجم ضمن الميزانية. |
| **الأمان** | **HTTPS و HSTS مفعلان** | **PASS:** الموقع يعيد التوجيه إلى HTTPS وترويسة HSTS موجودة. |
| | **ترويسات الأمان مطبقة** | **PASS:** نتيجة securityheaders.com هي "A" أو أعلى. |
| | **لا توجد ثغرات حرجة في التبعيات** | **PASS:** نتيجة `pnpm audit` لا تظهر أي ثغرات حرجة أو عالية. |
| **تحسين محركات البحث** | **`robots.txt` و `sitemap.xml` موجودان** | **PASS:** يمكن الوصول إلى كلا الملفين ويعملان بشكل صحيح. |
| | **العناوين الأساسية (Canonicals) صحيحة** | **PASS:** فحص عينة من الصفحات يظهر أن العناوين الأساسية صحيحة. |
| **الموثوقية** | **مراقبة وقت التشغيل مفعلة** | **PASS:** تم إعداد UptimeRobot ويراقب الموقع بنجاح. |
| | **تتبع الأخطاء (Sentry) مفعل** | **PASS:** تم إرسال خطأ تجريبي وظهر في لوحة تحكم Sentry. |
| **الامتثال** | **لافتة الموافقة على ملفات تعريف الارتباط تعمل** | **PASS:** نصوص التحليلات لا تعمل إلا بعد الحصول على موافقة المستخدم. |
