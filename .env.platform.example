# ════════════════════════════════════════════════════════════════
# MK Platform — Environment Variables
# Copy to .env and fill in values.
#
# SAFETY: All feature flags default to OFF (safest).
# SAFETY: All modes default to standalone (each site independent).
# ════════════════════════════════════════════════════════════════

# ── Database ─────────────────────────────────────────────────
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/mk_platform
REDIS_URL=redis://localhost:6379

# ── Beds24 API V2 ───────────────────────────────────────────
BEDS24_API_URL=https://api.beds24.com
BEDS24_REFRESH_TOKEN=
# Webhook Security — Beds24 does NOT sign webhooks with HMAC.
# Two layers: shared secret header (PRIMARY) + IP allowlist (OPTIONAL).
# Secrets are NEVER logged. See docs/PLATFORM_README.md for full details.
#
# PRIMARY: Static Shared Secret Header
# Set a matching "Custom Header" in Beds24 dashboard:
#   Beds24 → Settings → Account → Booking Webhooks → Custom Headers
#   Header name:  X-Webhook-Secret  (must match BEDS24_WEBHOOK_SECRET_HEADER below)
#   Header value: <same value as BEDS24_WEBHOOK_SECRET below>
# This is NOT HMAC — Beds24 sends the header as-is, we compare strings.
# Empty = check disabled (not recommended for production).
BEDS24_WEBHOOK_SECRET=
BEDS24_WEBHOOK_SECRET_HEADER=x-webhook-secret
#
# SECRET ROTATION (zero-downtime):
# To rotate the webhook secret without dropping requests:
#   1. Generate a new secret.
#   2. Set BEDS24_WEBHOOK_SECRET=<new secret>
#   3. Set BEDS24_WEBHOOK_SECRET_PREVIOUS=<old secret>
#   4. Set BEDS24_WEBHOOK_SECRET_ROTATION_START=<now, ISO 8601, e.g. 2026-03-01T00:00:00Z>
#   5. Deploy. Both secrets are now accepted.
#   6. Update Beds24 dashboard Custom Header to the new secret.
#   7. After ROTATION_WINDOW_DAYS (default 7), clear PREVIOUS and ROTATION_START. Deploy.
# STRICT: If PREVIOUS is set but ROTATION_START is missing, the previous secret is REJECTED.
# You MUST set ROTATION_START explicitly to activate the rotation window.
BEDS24_WEBHOOK_SECRET_PREVIOUS=
BEDS24_WEBHOOK_SECRET_ROTATION_START=
BEDS24_WEBHOOK_SECRET_ROTATION_WINDOW_DAYS=7
#
# OPTIONAL: IP Allowlist (defense-in-depth)
# Comma-separated Beds24 server IPs. Empty = disabled.
# Beds24 IPs may change without notice — use as secondary layer only.
# Get IPs from Beds24 support or observe X-Forwarded-For in initial test.
BEDS24_WEBHOOK_IP_ALLOWLIST=

# ── Mode Switches (standalone | integrated) ──────────────────
# standalone = adapter calls Beds24 directly, hub-api rejects writes (409)
# integrated = hub-api calls Beds24, adapter rejects writes (409)
# INVARIANT: Exactly ONE writer per brand at any time.
MODE_COBNB=standalone
MODE_MONTHLYKEY=standalone
MODE_OPS=standalone

# ── Feature Flags (all OFF by default = safest) ─────────────
# ENABLE_BEDS24:            Initialize Beds24 SDK in hub-api
# ENABLE_BEDS24_WEBHOOKS:   Accept webhooks (200+queue) vs reject (204)
# ENABLE_BEDS24_PROXY:      Admin proxy to Beds24 (ADMIN role only)
# ENABLE_AUTOMATED_TICKETS: Auto-create cleaning tickets on checkout
# ENABLE_PAYMENTS:          Payment endpoints active
# ENABLE_BANK_TRANSFER:     Bank transfer payment option visible
ENABLE_BEDS24=false
ENABLE_BEDS24_WEBHOOKS=false
ENABLE_BEDS24_PROXY=false
ENABLE_AUTOMATED_TICKETS=false
ENABLE_PAYMENTS=false
ENABLE_BANK_TRANSFER=false

# ── Payments (Moyasar) ──────────────────────────────────────
MOYASAR_API_KEY=
MOYASAR_PUBLISHABLE_KEY=
MOYASAR_WEBHOOK_SECRET=

# ── JWT / Auth ───────────────────────────────────────────────
JWT_SECRET=change-me-in-production
JWT_EXPIRES_IN=7d

# ── Service Ports ────────────────────────────────────────────
PORT_HUB_API=4000
PORT_COBNB_ADAPTER=4001
PORT_MK_ADAPTER=4002
PORT_WORKER=4003
PORT_COBNB_WEB=3000
PORT_MK_WEB=3001
PORT_OPS_WEB=3002

# ── Admin Proxy Rate Limit ───────────────────────────────────
# Max requests per minute per admin user to Beds24 proxy
ADMIN_PROXY_RATE_LIMIT=30

# ── Webhook Processing ──────────────────────────────────────
# Max retry attempts before dead-letter (default: 5)
WEBHOOK_MAX_RETRIES=5

# ── Logging ──────────────────────────────────────────────────
LOG_LEVEL=info
NODE_ENV=development
