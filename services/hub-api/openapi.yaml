openapi: 3.1.0
info:
  title: MK Hub API
  version: 0.1.0
  description: |
    Central API for the MK Platform â€” manages units, bookings, tickets,
    and Beds24 integration for both COBNB and Monthly Key brands.

servers:
  - url: http://localhost:4000
    description: Local development

paths:
  /api/v1/auth/login:
    post:
      summary: Login
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email: { type: string, format: email }
                password: { type: string, minLength: 8 }
              required: [email, password]
      responses:
        "200":
          description: JWT token
          content:
            application/json:
              schema:
                type: object
                properties:
                  token: { type: string }
                  user: { $ref: "#/components/schemas/User" }

  /api/v1/units:
    get:
      summary: List units
      tags: [Units]
      parameters:
        - name: mode
          in: query
          schema: { type: string, enum: [COBNB, MONTHLY_KEY] }
        - name: city
          in: query
          schema: { type: string }
        - name: page
          in: query
          schema: { type: integer, default: 1 }
        - name: limit
          in: query
          schema: { type: integer, default: 20 }
      responses:
        "200":
          description: Paginated unit list
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items: { $ref: "#/components/schemas/Unit" }
                  total: { type: integer }
                  page: { type: integer }

  /api/v1/bookings:
    post:
      summary: Create booking (idempotent)
      tags: [Bookings]
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                unitId: { type: string, format: uuid }
                checkIn: { type: string, format: date }
                checkOut: { type: string, format: date }
                idempotencyKey: { type: string }
                guestName: { type: string }
                guestPhone: { type: string }
              required: [unitId, checkIn, checkOut, idempotencyKey]
      responses:
        "201":
          description: Booking created
        "409":
          description: Date conflict

  /api/v1/tickets:
    get:
      summary: List ops tickets
      tags: [Tickets]
      security: [{ bearerAuth: [] }]
      parameters:
        - name: status
          in: query
          schema: { type: string, enum: [OPEN, IN_PROGRESS, COMPLETED, CANCELLED] }
        - name: type
          in: query
          schema: { type: string, enum: [CLEANING, MAINTENANCE, INSPECTION, TURNOVER] }
      responses:
        "200":
          description: Ticket list
    post:
      summary: Create ops ticket
      tags: [Tickets]
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/CreateTicket" }
      responses:
        "201":
          description: Ticket created

  /api/v1/webhooks/beds24:
    post:
      summary: Beds24 webhook receiver
      tags: [Webhooks]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        "200":
          description: Webhook processed

  /api/v1/admin/flags:
    get:
      summary: List feature flags
      tags: [Admin]
      security: [{ bearerAuth: [] }]
      responses:
        "200":
          description: Feature flags list

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    User:
      type: object
      properties:
        id: { type: string, format: uuid }
        email: { type: string }
        name: { type: string }
        role: { type: string, enum: [ADMIN, OWNER, TENANT, OPS_MANAGER, OPS_STAFF] }

    Unit:
      type: object
      properties:
        id: { type: string, format: uuid }
        beds24PropertyId: { type: string }
        title: { type: string }
        titleAr: { type: string }
        city: { type: string }
        district: { type: string }
        bookingMode: { type: string, enum: [COBNB, MONTHLY_KEY, DUAL] }
        pricePerNight: { type: number }
        pricePerMonth: { type: number }
        bedrooms: { type: integer }
        bathrooms: { type: integer }
        amenities: { type: array, items: { type: string } }
        images: { type: array, items: { type: string, format: uri } }
        isActive: { type: boolean }

    CreateTicket:
      type: object
      properties:
        unitId: { type: string, format: uuid }
        bookingId: { type: string, format: uuid }
        type: { type: string, enum: [CLEANING, MAINTENANCE, INSPECTION, TURNOVER] }
        priority: { type: string, enum: [LOW, MEDIUM, HIGH, URGENT] }
        description: { type: string }
      required: [unitId, type, priority]
